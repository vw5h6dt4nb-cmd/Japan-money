import streamlit as st
import datetime
import pandas as pd

# --- æ ¸å¿ƒè³‡æ–™çµæ§‹åˆå§‹åŒ–èˆ‡ç‹€æ…‹ç®¡ç† ---

# æª¢æŸ¥ä¸¦åˆå§‹åŒ– Session State ä¸­çš„è³‡æ–™çµæ§‹
def initialize_session_state():
    """åˆå§‹åŒ– Streamlit Session State ä¸­çš„è¨˜å¸³æœ¬ã€‚"""
    if 'exchange_book' not in st.session_state:
        st.session_state.exchange_book = [
            # åˆå§‹å…Œæ›ç´€éŒ„
            {
                "date": "2025-12-16", 
                "TWD_amount": 10000.0,
                "JPY_amount": 50000.0,
                "exchange_rate": 0.2000,
                "notes": "é¦–æ¬¡å…Œæ›"
            }
        ]
    if 'expense_book' not in st.session_state:
        st.session_state.expense_book = []

# --- A. æ›åŒ¯ç´€éŒ„ç®¡ç†å‡½æ•¸ (èª¿æ•´ç‚ºä½¿ç”¨ Session State) ---
def calculate_average_rate():
    """è¨ˆç®—ä¸¦å›å‚³å¹³å‡æ›åŒ¯æˆæœ¬ç‡ (TWD/JPY)ã€‚"""
    exchange_book = st.session_state.exchange_book
    if not exchange_book:
        return 0.0

    total_twd = sum(item["TWD_amount"] for item in exchange_book)
    total_jpy = sum(item["JPY_amount"] for item in exchange_book)

    return total_twd / total_jpy if total_jpy > 0 else 0.0

def add_exchange_record(date, twd, jpy, notes=""):
    """æ–°å¢ä¸€ç­†å…Œæ›ç´€éŒ„ï¼Œä¸¦è¨ˆç®—åŒ¯ç‡ã€‚"""
    if twd > 0 and jpy > 0:
        rate = twd / jpy
        new_record = {
            "date": date.strftime('%Y-%m-%d'),
            "TWD_amount": twd,
            "JPY_amount": jpy,
            "exchange_rate": round(rate, 4), 
            "notes": notes
        }
        st.session_state.exchange_book.append(new_record)
        st.success(f"âœ… æˆåŠŸæ–°å¢æ›åŒ¯ç´€éŒ„: {twd:,.2f} TWD å…Œæ› {jpy:,.0f} JPY, åŒ¯ç‡ç‚º {round(rate, 4)}")
    else:
        st.error("âŒ æ›åŒ¯é‡‘é¡è¼¸å…¥å¿…é ˆå¤§æ–¼é›¶ã€‚")

# --- B. æ¶ˆè²»è¨˜å¸³èˆ‡æ›ç®—å‡½æ•¸ ---
def add_expense_record(date, jpy_amount, description):
    """æ–°å¢ä¸€ç­†æ—¥å¹£æ¶ˆè²»ç´€éŒ„ï¼Œä¸¦è‡ªå‹•æ›ç®—æˆå°å¹£æˆæœ¬ã€‚"""
    if jpy_amount <= 0:
        st.error("âŒ æ¶ˆè²»é‡‘é¡å¿…é ˆå¤§æ–¼é›¶ã€‚")
        return
    
    avg_rate = calculate_average_rate()
    
    if avg_rate == 0:
        twd_cost = 0.0
    else:
        twd_cost = jpy_amount * avg_rate

    new_expense = {
        "date": date.strftime('%Y-%m-%d'),
        "JPY_amount": jpy_amount,
        "TWD_cost": round(twd_cost, 2),
        "description": description,
        "rate_used": round(avg_rate, 4)
    }
    st.session_state.expense_book.append(new_expense)
    st.success(f"âœ… æ–°å¢æ¶ˆè²»: **{description}**")
    st.info(f"æ—¥å¹£èŠ±è²»: Â¥{jpy_amount:,.0f} -> **å°å¹£æˆæœ¬: ${round(twd_cost, 2):,}** (ä½¿ç”¨åŒ¯ç‡: {round(avg_rate, 4)})")


# --- C. ç¶²é ä»‹é¢é¡¯ç¤ºå‡½æ•¸ ---
def display_summary():
    """é¡¯ç¤ºç¸½çµè³‡è¨Šã€‚"""
    exchange_book = st.session_state.exchange_book
    expense_book = st.session_state.expense_book
    
    total_twd_exchanged = sum(item["TWD_amount"] for item in exchange_book)
    total_jpy_received = sum(item["JPY_amount"] for item in exchange_book)
    total_jpy_spent = sum(item["JPY_amount"] for item in expense_book)
    total_twd_spent_cost = sum(item["TWD_cost"] for item in expense_book)
    
    remaining_jpy = total_jpy_received - total_jpy_spent
    avg_rate = calculate_average_rate()

    st.subheader("ğŸ“Š è¨˜å¸³ç¸½è¦½")
    
    # ä½¿ç”¨ Streamlit çš„ columns æ’ç‰ˆ
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            label="**å¹³å‡æ›åŒ¯æˆæœ¬ (TWD/JPY)**",
            value=f"{avg_rate:.4f}"
        )
    with col2:
        st.metric(
            label="**ç¸½æ›å¾—æ—¥å¹£**",
            value=f"Â¥{total_jpy_received:,.0f}"
        )
    with col3:
        # æ ¹æ“šé¤˜é¡é¡¯ç¤ºä¸åŒé¡è‰²
        if remaining_jpy >= 0:
            st.metric(
                label="**å‰©é¤˜æ—¥å¹£**",
                value=f"Â¥{remaining_jpy:,.0f}"
            )
        else:
             st.metric(
                label="**å‰©é¤˜æ—¥å¹£ (è¶…æ”¯)**",
                value=f"Â¥{remaining_jpy:,.0f}",
                delta="è«‹æ³¨æ„è¶…æ”¯",
                delta_color="inverse"
            )

    st.markdown("---")
    
    col4, col5 = st.columns(2)
    with col4:
        st.metric(
            label="ç¸½æ›åŒ¯å°å¹£é‡‘é¡",
            value=f"${total_twd_exchanged:,.2f}"
        )
    with col5:
        st.metric(
            label="ç¸½å°å¹£æ¶ˆè²»æˆæœ¬",
            value=f"${round(total_twd_spent_cost, 2):,}"
        )
        
    return remaining_jpy # å›å‚³å‰©é¤˜é‡‘é¡

def display_all_records():
    """é¡¯ç¤ºè©³ç´°çš„æ›åŒ¯èˆ‡æ¶ˆè²»ç´€éŒ„ã€‚"""
    
    st.subheader("ğŸ’° æ›åŒ¯ç´€éŒ„")
    if st.session_state.exchange_book:
        df_exchange = pd.DataFrame(st.session_state.exchange_book)
        st.dataframe(df_exchange, hide_index=True, use_container_width=True)
    else:
        st.info("ç›®å‰æ²’æœ‰ä»»ä½•æ›åŒ¯ç´€éŒ„ã€‚")

    st.subheader("ğŸ’¸ è©³ç´°æ¶ˆè²»ç´€éŒ„")
    if st.session_state.expense_book:
        df_expense = pd.DataFrame(st.session_state.expense_book)
        # é‡æ–°å‘½åæ¬„ä½ä»¥ä¾¿æ–¼é–±è®€
        df_expense.columns = ["æ—¥æœŸ", "æ—¥å¹£èŠ±è²» (JPY)", "å°å¹£æˆæœ¬ (TWD)", "æè¿°", "æ›ç®—åŒ¯ç‡"]
        st.dataframe(df_expense, hide_index=True, use_container_width=True)
    else:
        st.info("ç›®å‰æ²’æœ‰ä»»ä½•æ¶ˆè²»ç´€éŒ„ã€‚")


# --- D. æ‡‰ç”¨ç¨‹å¼ä¸»é«” (Main App) ---
def main_app():
    """Streamlit æ‡‰ç”¨ç¨‹å¼çš„ä¸»é«”ã€‚"""
    
    st.set_page_config(layout="wide", page_title="æ—…éŠæ›åŒ¯è¨˜å¸³æœ¬")
    st.title("âœˆï¸ æ—…éŠæ›åŒ¯è¨˜å¸³æœ¬")
    st.caption("ä½¿ç”¨å¹³å‡æˆæœ¬æ³•è¨ˆç®—æ¶ˆè²»çš„å°å¹£æˆæœ¬")

    initialize_session_state()

    # å´é‚Šæ¬„ç”¨æ–¼æ–°å¢ç´€éŒ„
    with st.sidebar:
        st.header("åŠŸèƒ½é¸å–®")
        
        # --- 1. æ–°å¢æ›åŒ¯ç´€éŒ„ ---
        st.markdown("### ğŸ’° æ–°å¢æ›åŒ¯")
        exchange_date = st.date_input("æ—¥æœŸ", value=datetime.date.today(), key='ex_date')
        twd_input = st.number_input("å…Œæ›çš„å°å¹£ (TWD) é‡‘é¡", min_value=0.0, step=100.0, key='ex_twd')
        jpy_input = st.number_input("æ›å¾—çš„æ—¥å¹£ (JPY) é‡‘é¡", min_value=0.0, step=1000.0, key='ex_jpy')
        notes_input = st.text_input("å‚™è¨» (å¯é¸)", key='ex_notes')
        
        if st.button("ğŸ’¾ è¨˜éŒ„æ›åŒ¯"):
            add_exchange_record(exchange_date, twd_input, jpy_input, notes_input)
            
        st.markdown("---")
        
        # --- 2. æ–°å¢æ¶ˆè²»ç´€éŒ„ ---
        st.markdown("### ğŸ’¸ æ–°å¢æ¶ˆè²»")
        expense_date = st.date_input("æ—¥æœŸ", value=datetime.date.today(), key='exp_date')
        description_input = st.text_input("æ¶ˆè²»é …ç›®æè¿°", key='exp_desc')
        jpy_exp_input = st.number_input("æ—¥å¹£ (JPY) èŠ±è²»é‡‘é¡", min_value=0.0, step=100.0, key='exp_jpy')
        
        if st.button("ğŸ›’ è¨˜éŒ„æ¶ˆè²»"):
            remaining_jpy = display_summary() # ç‚ºäº†å–å¾—æœ€æ–°çš„å‰©é¤˜é‡‘é¡
            # ç°¡å–®çš„è¶…æ”¯æª¢æŸ¥ (Streamlit æœƒåœ¨é é¢åˆ·æ–°æ™‚é‡æ–°è¨ˆç®—)
            if st.session_state.exchange_book and jpy_exp_input > 0 and jpy_exp_input > remaining_jpy:
                st.warning(f"âš ï¸ è­¦å‘Šï¼šæ¶ˆè²» Â¥{jpy_exp_input:,.0f} è¶…éå‰©é¤˜æ—¥å¹£ã€‚")

            add_expense_record(expense_date, jpy_exp_input, description_input)

    # ä¸»é é¢é¡¯ç¤ºç¸½è¦½å’Œç´€éŒ„
    display_summary()
    st.markdown("---")
    display_all_records()

if __name__ == "__main__":
    main_app()
